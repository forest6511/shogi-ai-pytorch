# 将棋ルール参照

実装時のルール確認用リファレンス。詳しいルール説明は書籍本文を参照。

---

## どうぶつしょうぎ（第4〜12章）

### 盤面
3列 × 4行（列: 0〜2、行: 0〜3）

### 駒と動き

| 駒 | 内部記号 | 動き |
|---|---|---|
| 獅子（ライオン） | `L` | 8方向1マス |
| 象（エレファント）| `E` | 斜め4方向1マス |
| キリン | `G` | 上下左右4方向1マス |
| ひよこ | `C` | 前1マス（自分の進行方向） |
| にわとり（成りひよこ）| `H` | 斜め後ろ2方向 以外の6方向 |

### 先手・後手の向き
- **先手**: 盤面下側（行インデックス 3）、上方向（行が減る方向）が前
- **後手**: 盤面上側（行インデックス 0）、下方向（行が増える方向）が前

### 特殊ルール
- **成り**: ひよこが相手陣の最奥行（先手→行0、後手→行3）に到達したとき、にわとりに自動成り
- **トライルール**: 獅子が相手の獅子の初期位置に入ると即勝ち（ただし取られる位置への移動は禁止）
- **持ち駒**: 取った駒は任意の空きマスに打てる（獅子は打てない）
- **王手放置禁止**: 自分の獅子が取られる手は指せない

### テンソル表現（第8〜9章、14チャンネル）

AlphaZero は常に「現プレイヤーの視点」でテンソルを作る。

```
Ch.0〜4:   現プレイヤーの盤上の駒（Chick, Giraffe, Elephant, Lion, Hen）
Ch.5〜9:   相手プレイヤーの盤上の駒
Ch.10〜12: 現プレイヤーの持ち駒数（Chick, Giraffe, Elephant の順）
Ch.13:     手番インジケータ（先手番なら全マス1.0、後手番なら全マス0.0）
```

---

## 本将棋（第13〜14章）

### 盤面
9列 × 9行（標準将棋）

### 実装で必要な主要ルール

**成り**
- 相手陣（相手側の上位3行）に入ったとき、または相手陣から出るときに成れる
- 成りは任意（強制ではない）。ただし動けなくなる場合は強制成り
- 成り駒は元の駒に戻せない

**打ち禁止ルール**
- **二歩禁止**: 同じ列に自分の歩（未成り）が2枚以上あるとき、その列に歩を打てない
- **打ち歩詰め禁止**: 歩を打って相手玉を即詰みにする手は禁止
- **行き所のない駒**: 動けなくなるマスへの打ちは禁止（歩・香→最奥行、桂→最奥2行）

**千日手**
- 同一局面が4回出現すると引き分け（実装では省略可）

### 合法手の数（初期局面）
- 先手の合法手数 = **30手**（歩×9 + 各駒の動き）
- テストで `assert len(legal_moves) == 30` を使って検証する

### 駒の総数（先手・後手各）
歩×9, 香×2, 桂×2, 銀×2, 金×2, 角×1, 飛×1, 王×1 = 20枚

---

## 共通の実装パターン

### 不変 State（MCTS用）
```python
# 正しい実装: apply_move は新しい State を返す
new_state = state.apply_move(move)

# 誤り: State を直接変更しない
state.board[row][col] = piece  # NG
```

### Protocol の確認
```bash
# GameState インターフェースを確認する
cat src/shogi_ai/game/protocol.py
```
